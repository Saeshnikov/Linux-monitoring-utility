# Информация о собираемых метриках

| Пункт мониторинга | bpftrace-скрипт| Собираемые данные | Установление связей |
| :---: | --- | --- | --- |
| Сокеты | `socket.bt` | - полный путь исполняемого файла <br>- тип syscall (accept/connect) <br>- протокол (UNIX, INET, INET6) <br>- файловый дескриптор сокета |  Пример вывода: <br>*`Attaching 5 probes...` <br> `/snapshot/usr/bin/VBoxClient C UNIX 7` <br>`/snapshot/usr/bin/X ` <br>`/home/anna/Desktop/bpftrace/socket/socket_server  `<br>`/home/anna/Desktop/bpftrace/socket/socket_client C INET 3` <br>`/snapshot/usr/bin/VBoxClient C UNIX 7` <br>`/snapshot/usr/sbin/nscd C INET 18` <br>`/snapshot/usr/sbin/nscd C INET 18` <br>`/snapshot/usr/sbin/nscd C INET 18`<br>`/snapshot/usr/lib/snapd/snapd C UNIX 3` <br>`/snapshot/usr/bin/VBoxClient C UNIX 7` <br>`/home/anna/Desktop/bpftrace/socket/socket_server A INET 3` <br>`/home/anna/Desktop/bpftrace/socket/socket_client C INET 3` <br>`/snapshot/usr/bin/VBoxClient C UNIX 7`*  <br><br>Определение взаимодействующих процессов будет производится на основе соотношения типа syscall (accept|connect) и файлового дескриптора сокета. |
| Именованные каналы (SystemV/Posix) | `namedpipes.bt` | - полный путь исполняемого файла <br>- файловый дескриптор канала <br>- имя канала | Пример вывода: <br>*`Attaching 12 probes...`<br>`/home/anna/Desktop/bpftrace/pipe/fifoserver.out 3 MYFIFO`<br>`/home/anna/Desktop/bpftrace/pipe/fifoserver.out 4 MYFIFO`<br>`/home/anna/Desktop/bpftrace/pipe/fifoserver.out 5 MYFIFO`<br>`/home/anna/Desktop/bpftrace/pipe/fifo1.out 3 myfifo2`<br>`/home/anna/Desktop/bpftrace/pipe/fifo2.out 3 myfifo2`<br>`/home/anna/Desktop/bpftrace/pipe/fifo1.out 3 myfifo2`<br>`/home/anna/Desktop/bpftrace/pipe/fifo2.out 3 myfifo2`<br>`/home/anna/Desktop/bpftrace/pipe/fifo2.out 3 myfifo2`* <br><br>Взаимодейтсиве определяется двумя способами: <br>1. Соотнести по имени канала в результирующем файле текущего скрипта. <br>2. Соотнести полный путь исполняемого файла с файлом в который он пишнт/читает по результатам работы скрипта `fsorw.bt`. |
| Семафоры (SystemV) | `semaphores.bt` | - полный путь исполняемого файла <br>- key семафорв (16Ссч) <br>- id семафорв |  Пример вывода: <br>*`Attaching 6 probes...`<br>`/home/anna/Desktop/bpftrace/IPC/semtest 12345 4`<br>`/home/anna/Desktop/bpftrace/IPC/semtest 12345 4`<br>`/home/anna/Desktop/bpftrace/IPC/semtest 12345 4`<br>`/home/anna/Desktop/bpftrace/IPC/semtest 12345 4`* <br><br>Здесь взаимодейтсиве определяется не между файлами, а различних файлов с одном и тем же семафором, сделать это возможно через соотношение одинаковых id и полных путей фалов.|
| Общая память (SystemV/Posix) | `sharedMem.bt` | - полный путь исполняемого файла <br>- key участка шареной памяти(SystemV)/полный пусть с именем shm или sem(Posix) <br>- id участка шареной памяти <br>- тип (SystemV/Posix) | Пример вывода: <br>*`Attaching 9 probes...`<br>`/home/anna/Desktop/bpftrace/IPC/shmwrite ffffffff 3538963 systemV`<br>`/home/anna/Desktop/bpftrace/IPC/shmread ffffffff 3538963 systemV`<br>`/home/anna/Desktop/bpftrace/IPC/producer /dev/shm/OS 3 posix`<br>`/home/anna/Desktop/bpftrace/IPC/consumer /dev/shm/OS 3 posix`<br>`/home/anna/Desktop/bpftrace/IPC/posixSemTest /dev/shm/sem.my_named_semaphore 3 posix`<br>`/home/anna/Desktop/bpftrace/IPC/posixSemTest /dev/shm/sem.my_named_semaphore 3 posix`*<br><br>Аналогично предыдущему варианту, рассматривается взаимодействие "одного ко многим". <br>Определить, является ли тип взаимодействия общей памятью или семафоров в случае стандарта posix возможно с помощью ключевого слова `sem.` перед именем, который присваевается автоматически системой.|
| Чтение/запись одного файла в другой | `fsorw.bt` | - полный путь исполняемого файла <br>- файловый дескриптор открываемого им файла <br>- полный путь к открываемому файлу <br>- кол-во считанных байт <br>- кол-во записанных байт | Пример вывода: <br>*`Attaching 51 probes...`<br>`/snapshot/usr/bin/X 64 /usr/bin/VBoxClient 31 0`<br>`/home/anna/Desktop/bpftrace/pipe/fifoserver.out 3 /lib64/libc.so.6 832 0`<br>`/snapshot/usr/bin/VBoxClient 8 /run/user/1000/xauth_BkPaXD 111 0`<br>`/home/anna/Desktop/bpftrace/pipe/fifoclient.out 3 /lib64/libc.so.6 832 0`<br>`/home/anna/Desktop/bpftrace/pipe/fifoclient.out 3 MYFIFO 0 14`<br>`/home/anna/Desktop/bpftrace/pipe/fifoserver.out 4 MYFIFO 3 0`<br>`/home/anna/Desktop/bpftrace/pipe/fifoserver.out 5 MYFIFO 3 0`<br>`/snapshot/usr/bin/VBoxClient 8 /run/user/1000/xauth_BkPaXD 111 0`<br>`/snapshot/usr/bin/X 64 /usr/bin/VBoxClient 31 0`<br>`/snapshot/usr/bin/plasmashell -1 / 8 0`<br>`/snapshot/usr/bin/VBoxClient 8 /run/user/1000/xauth_BkPaXD 111 0`<br>`/home/anna/Desktop/bpftrace/IPC/shmcreate 3 /lib64/libc.so.6 832 0`<br>`/snapshot/usr/bin/VBoxClient 8 /run/user/1000/xauth_BkPaXD 111 0`<br>`/snapshot/usr/bin/X 64 /usr/bin/VBoxClient 31 0`<br>`/snapshot/usr/bin/bash 3  0 5`<br>`/home/anna/Desktop/bpftrace/IPC/shmwrite 3 /lib64/libc.so.6 832 0`<br>`/snapshot/usr/bin/X 64 /usr/bin/VBoxClient 31 0`<br>`/home/anna/Desktop/bpftrace/IPC/shmrmid 3 /lib64/libc.so.6 832 0`* <br><br>Результат работы этого скрипта может быть использован для установление взаимосвязи между процессами. |

> Присутствует ограничение на вложенность файловой системы с глубиной вложенности в 3000.

> ***Особенность реализации sharedMem.bt*** <br>При реализации `sharedMem.bt` для posix стандарта использование системного вызова `shm_open` оказалось невозможным в силу того, что в linux он не реализован как systemcall и помечен в документации (3), а не (2), единственные syscalls, которые учавсвуют в создании данного ipc являются `ftruncate` и `mmap`: <br>- `ftruncate` отвечает за выделение памяти, но из него не возможно полуить имя участка, что не позволяет определить взаимодействиующие процессы <br>- `mmap` не является уникальным для данного типа ipc, поэтому по нему не возможно определить тип ipc.
> <br>Поэтому для выявляения данного взаимодействия используется проверка на открытие директории `/dev/shm` (содержит созданные posix семафоры и общую память) и дальнейшей фильтрациии по имени, полученном оттуда, что позволило отлавливать также и posix semaphores (в данной директории они создаются с добавлением `sem.` перед именем семафора).

### Пункты мониторинга, которые нет возможности собирать:
   - Неименнованные канал (из-за специфики системного вызова не может получить fd канала, для дальнейшей фильтрации других системных вызовов по нему) `!` Однако, косвенно, взаимодействие можно определить с помощью скрипта `fsorw.bt`.
